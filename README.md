
# 돈 뿌리기 API (practice project)
- 카카오페이의 돈 뿌리기 기능 구현 연습 프로젝트

## Introduction

카카오페이에는 머니 뿌리기 기능이 있습니다.

- 사용자는 다수의 친구들이 있는 대화방에서 뿌릴 금액과 받아갈 대상의 숫자를 입력하여 뿌리기 요청을 보낼 수 있습니다.
- 요청 시 자신의 잔액이 감소되고 대화방에는 뿌리기 메세지가 발송됩니다.
- 대화방에 있는 다른 사용자들은 위에 발송된 메세지를 클릭하여 금액을 무작위로 받아가게 됩니다.

> 이번 과제에서는 UI 및 메세지 영역은 제외한 간소화된 REST API를 구현하는 것이 목표입니다.

---

## 요구 사항

- 뿌리기, 받기, 조회 기능을 수행하는 REST API를 구현합니다.
- 요청한 사용자의 식별값은 숫자 형태이며 `"X-USER-ID"` 라는 HTTP Header로 전달됩니다.
- 요청한 사용자가 속한 대화방의 식별값은 문자 형태이며 `"X-ROOM-ID"` 라는 HTTP Header로 전달됩니다.
- 모든 사용자는 뿌리기에 충분한 잔액을 보유하고 있다고 가정합니다.
- 다수 서버 인스턴스로 실행되어도 기능에 문제가 없도록 설계되어야 합니다.
- 각 기능 및 제약사항에 대한 단위테스트를 반드시 작성합니다.

---

## 상세 구현 요건 및 제약사항

### 1. 뿌리기 API

- 뿌릴 금액, 뿌릴 인원을 요청값으로 받습니다.
- 뿌리기 요청건에 대한 고유 token을 발급하고 응답값으로 내려줍니다.
- 뿌릴 금액을 인원수에 맞게 분배하여 저장합니다. (분배 로직은 자유롭게 구현)
- token은 3자리 문자열로 구성되며 예측이 불가능해야 합니다.

### 2. 받기 API

- 뿌리기 시 발급된 token을 요청값으로 받습니다.
- token에 해당하는 뿌리기 건 중 아직 누구에게도 할당되지 않은 분배건 하나를 요청 사용자에게 할당하고 금액을 응답합니다.
- 뿌리기당 한 사용자는 한 번만 받을 수 있습니다.
- 자신이 뿌리기한 건은 자신이 받을 수 없습니다.
- 같은 대화방 사용자만 받을 수 있습니다.
- 뿌리기는 **10분간만 유효**합니다. 이후 요청은 실패 응답.

### 3. 조회 API

- 뿌리기 시 발급된 token을 요청값으로 받습니다.
- 해당 token의 뿌리기 상태를 조회합니다. (뿌린 시각, 총금액, 받은 금액, [받은 금액, 사용자 ID] 리스트)
- 뿌린 사람 자신만 조회할 수 있습니다.
- 유효하지 않은 token이나 타인의 뿌리기는 조회 실패.
- 조회는 **7일간만 유효**합니다.

---
# 문제 풀이

**JAVA17, Spring(boot), JPA, H2 Database**
### 뿌리기 API
1. 요청값 검증
2. 요청에 맞게 'Spread' 객체를 생성, 뿌려진 금액에 대한 'SpreadDetail' 객체들 생성
3. 생성된 Spread의 token 값 응답

### 받기 API
1. 요청값 검증
2. 요청한 token의 Spread '받기' 가능 여부 확인
3. 요청한 token의 SpreadDetail 중 할당되지 않은 객체 할당
4. 할당된 객체의 distributedMoney 값 응답

### 조회 API
1. 요청값 검증
2. 요청한 token의 Spread '조회' 가능 여부 확인
3. 요청한 token의 Spread, SpreadDetail의 현재 상태 응답

#### 만료된 뿌리기(ExpiredSpread)
token 값은 3자리 무작위 문자열이며 고유해야 함.  
하지만 허용되는 문자열에 따라 다르지만 개수의 한계가 있음.  
ExpiredSpread는 Spread와 SpreadDetail의 정보를 한 객체에서 관리하며, 요청에 의한 사용 용도가 아닌 데이터 기록 용도
1. 뿌리기 건이 조회 만료 상태일 경우 Spread, SpreadDetail 테이블에서 제거한 후 ExpiredSpread 테이블로 데이터 이관
- 조회 요청시 조회 만료된 Spread라면 이관 로직 실행 
- 정해진 시간마다 Scheduler를 실행하여 만료된 Spread 확인 후 이관 로직 실행

#### Work Flow
*Client* <-(HTTP)-> **Controller, Scheduler** <-(DTO, parameter)-> **Service** <-(Entity, parameter)-> **Repository** <-(Entity)-> *DB*

### 보완 사항
1. **[완료]** 만료된 뿌리기 이관 로직 실행 수정 예정. (Scheduler only)
2. **[예정]** 뿌리기 및 받기 API 에서 다수의 사용자 요청이 동시에 온다면 문제가 발생 될 수 있음.
3. **[예정]** 테스트 환경을 각각 따로 할 필요성이 있음.
